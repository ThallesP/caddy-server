{
    servers {
        trusted_proxies static private_ranges
        client_ip_headers X-Forwarded-For X-Real-IP
    }
}

:{$PORT} {
    # Only allow specific IP to reverse proxy
    @allowed {
        client_ip {$ALLOWED_PROXY_IP}
    }
    
    # Handle requests from allowed IP
    handle @allowed {
        reverse_proxy n8n.railway.internal:5678 {
            # Forward the real client IP
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Host {host}
        }
    }

    # Reject all other requests
    handle {
        respond 403
    }
}
